# 部署指南

本文档简要说明如何将项目部署到生产服务器。

## 1. 环境准备
确保服务器已安装：
- **Docker** (20.10+)
- **Docker Compose** (v2.0+)

## 2. 修改配置文件 (`.env`)
在项目根目录下创建或修改 `.env` 文件，确保以下生产环境配置：

```bash
# 数据库配置
MYSQL_ROOT_PASSWORD=your_secure_root_password
MYSQL_PASSWORD=your_secure_user_password

# JWT 密钥（务必修改为一个随机长字符串）
JWT_SECRET=your_random_long_secret_string

# 前端访问地址（用于邮件激活链接的生成）
# 务必修改为你的服务器公网 IP 或域名
FRONTEND_BASE=http://服务器公网IP:3000

# 邮件发送配置（用于发送激活邮件）
MAIL_HOST=smtp.qq.com
MAIL_USERNAME=你的邮箱@qq.com
MAIL_PASSWORD=你的授权码
```

## 3. 限制对外端口 (`docker-compose.yml`)
为了安全起见，根据你的 NAT 要求，已修改 `docker-compose.yml`，仅保留 3000 和 8080 端口对外开放。

- **3000**: 前端商城界面。
- **8080**: Adminer 数据库管理工具。
- **后端 API (8081)**: 已关闭对外直接访问，前端将通过 Nginx 代理访问后端。

**修改后的 `ports` 状态：**
- `db`: 已关闭对外端口。
- `redis`: 已关闭对外端口。
- `mailhog`: 已关闭对外端口。
- `app`: 已关闭对外端口（由前端 Nginx 代理）。
- `adminer`: **8080:8080** (保留)。
- `frontend`: **3000:80** (保留)。

## 4. 准备静态资源
确保服务器上的项目根目录下存在 `uploads` 文件夹，并包含你需要的商品图片。
```bash
mkdir -p uploads
# 将你的图片放入 uploads/ 文件夹中
```

## 5. 启动部署
在项目根目录下执行：

```bash
# 构建并后台启动
docker compose up -d --build
```

## 6. 验证
- 访问 `http://服务器公网IP:3000` 进入商城。
- 访问 `http://服务器公网IP:8081/api/health` 检查后端状态。

## 注意事项
- **防火墙**：确保服务器防火墙（如 ufw 或安全组）已放行 3000 和 8081 端口。
- **数据持久化**：数据库文件存储在 `db_data` 卷中，图片存储在 `./uploads` 目录中，建议定期备份。
