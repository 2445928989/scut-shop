# é¡¹ç›®è®¾è®¡æ–‡æ¡£

> æœ¬æ–‡æ¡£æ±‡æ€»é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€å…³é”®ç»„ä»¶ã€éƒ¨ç½²æ–¹å¼ä¸æ—¥å¸¸å¼€å‘/è¿ç»´æ—¶éœ€è¦æ³¨æ„çš„ç‚¹ï¼Œæ–¹ä¾¿å›¢é˜Ÿæˆå‘˜å¿«é€Ÿäº†è§£ç³»ç»Ÿå¹¶è¿›è¡Œç»´æŠ¤ã€‚

---

## ğŸš€ é¡¹ç›®æ¦‚è§ˆ
- æŠ€æœ¯æ ˆï¼š
  - åç«¯ï¼šJava 17, Spring Boot, MyBatis
  - å‰ç«¯ï¼šVue 3 (Vite), Pinia, Element Plus
  - DBï¼šMySQLï¼ˆç”Ÿäº§ï¼‰ï¼ŒH2ï¼ˆæµ‹è¯•/å¼€å‘ï¼‰
  - ç¼“å­˜/ä¼šè¯ï¼šRedis
  - é‚®ä»¶ï¼šMailHogï¼ˆå¼€å‘ï¼‰
  - æµ‹è¯•ï¼šJUnitã€Playwrightï¼ˆE2Eï¼‰
  - éƒ¨ç½²ï¼šDocker Compose

## ğŸ— ä½“ç³»æ¶æ„ï¼ˆé€»è¾‘è¯´æ˜ï¼‰
- å‰ç«¯ï¼ˆ`frontend/`ï¼‰
  - SPA åº”ç”¨ï¼Œè´Ÿè´£ç”¨æˆ·ä¸ç®¡ç†ç«¯ç•Œé¢
  - ä½¿ç”¨ `accessToken` å­˜äº `localStorage`ï¼ˆç”¨äº API è°ƒç”¨ï¼‰
  - Admin è·¯ç”±ä½¿ç”¨è·¯ç”±å®ˆå«å¹¶é€šè¿‡ `/api/auth/me` æ ¡éªŒæƒé™
- åç«¯ï¼ˆ`backend/`ï¼‰
  - å„å±‚åˆ†ç¦»ï¼šController -> Service -> Mapperï¼ˆMyBatisï¼‰ -> DB
  - å®‰å…¨ï¼šJWTï¼ˆ`JwtAuthenticationFilter`ï¼‰+ æ–¹æ³•çº§ `@PreAuthorize("hasAuthority('ROLE_ADMIN')")`
  - ç®¡ç†æ“ä½œæœ‰å®¡è®¡ï¼ˆ`product_audit` è¡¨ï¼‰ä¸è½¯åˆ é™¤ï¼ˆstatus å­—æ®µï¼‰
- æ•°æ®ï¼šMySQLï¼Œ`db/schema.sql` ä¿æŒä¸» schemaï¼Œ`h2-init.sql` ç”¨äºé›†æˆ/æµ‹è¯•ç¯å¢ƒ
- å¼€å‘/é›†æˆï¼šä½¿ç”¨ Docker Compose å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆdbã€appã€frontendã€redisã€mailhogã€adminerï¼‰

## ğŸ”§ å…³é”®åç«¯å®ç°ç»†èŠ‚
- è®¤è¯/é‰´æƒ
  - JWT ç”± `JwtTokenProvider` äº§ç”Ÿ/éªŒè¯ï¼Œroles ä½œä¸º claim å­˜å‚¨
  - `JwtAuthenticationFilter` è´Ÿè´£æŠŠ token è§£æä¸º `Authentication`
- äº§å“è½¯åˆ é™¤ä¸å®¡è®¡
  - è½¯åˆ é™¤ï¼š`product.status = 0`ï¼ˆä¸‹æ¶ï¼‰ï¼Œå®é™…ä¸ä» DB åˆ é™¤
  - å®¡è®¡ï¼šæ“ä½œå†™å…¥ `product_audit`ï¼ˆaction, actor, detailsï¼‰è¡¨
- å¼‚å¸¸ä¸å®‰å…¨
  - `/error` è·¯å¾„éœ€å…è®¸åŒ¿åè®¿é—®ï¼Œé¿å…å¼‚å¸¸è½¬å‘è§¦å‘ 403ï¼ˆè§æ•…éšœæ’æŸ¥ï¼‰
  - è¯·æ±‚é˜²ç«å¢™ï¼ˆStrictHttpFirewallï¼‰ä¼šæ‹’ç»å« `//` çš„ URL
- æµ‹è¯•
  - å•å…ƒï¼šMockito + JUnit
  - é›†æˆï¼šåœ¨éœ€è¦æ—¶ä½¿ç”¨ Testcontainers æˆ– H2ï¼ˆé¿å…æ¯æ¬¡éƒ½è¿å¤–éƒ¨ MySQLï¼‰

## ğŸ§­ å‰ç«¯æ³¨æ„ç‚¹
- ç™»å½•æµç¨‹ï¼š`/api/auth/login` è¿”å› tokenï¼Œå‰ç«¯æŠŠ token å­˜ `localStorage` å¹¶åœ¨ `fetchMe()` ä¸­åŒæ­¥ç”¨æˆ·ä¿¡æ¯
- Admin é¡µé¢ï¼šåŸºäº `isAdmin` æ˜¾ç¤ºè·¯ç”±ä¸æ“ä½œæŒ‰é’®ï¼›åœ¨æ—  authorities æ—¶ä¼šè§¦å‘ `fetchMe()` æ¥åˆ·æ–°
- E2Eï¼šPlaywright ç”¨æ¥è¦†ç›–ä¸»è¦åœºæ™¯ã€‚å¯¹ flaky çš„ UI æ“ä½œï¼Œä¼˜å…ˆä½¿ç”¨ API é©±åŠ¨ï¼ˆæ›´ç¨³å®šï¼‰

## âœ… éƒ¨ç½²ä¸è¿ç»´ï¼ˆå¸¸ç”¨å‘½ä»¤ï¼‰
- å¯åŠ¨ï¼ˆæ„å»ºé•œåƒå¹¶åå°è¿è¡Œï¼‰ï¼š
  - docker compose up -d --build
- ä»…é‡å¯æœåŠ¡ï¼ˆä¸ rebuildï¼‰ï¼š
  - docker compose restart app
- é‡å»ºå¹¶è¿è¡Œå•ä¸ªæœåŠ¡ï¼š
  - docker compose up -d --no-deps --build app
- å¿«é€Ÿ smoke checksï¼ˆæ¨èåœ¨ deploy åè¿è¡Œï¼‰ï¼š
  - curl -fsS http://localhost:8081/api/health
  - curl -fsS -H "Authorization: Bearer <token>" http://localhost:8081/api/auth/me

- å¿«é€Ÿé•œåƒæ„å»ºï¼ˆèŠ‚çœå¤§é‡æ—¶é—´ï¼‰:
  - Dockerfile æ”¯æŒæ„å»ºå‚æ•°ï¼ˆä¾‹å¦‚ `SKIP_TESTS`, `SKIP_REPACKAGE`, `MVN_THREADS`ï¼‰ï¼Œå¯ç”¨äºåœ¨æœ¬åœ°å¿«é€Ÿè¿­ä»£æ„å»ºã€‚
  - ä¸ºä¿æŒæ¼”ç¤ºç®€æ´ï¼Œä»“åº“å·²ç§»é™¤ Makefile ä¸æŸäº›é«˜çº§è‡ªåŠ¨åŒ–è„šæœ¬ï¼›å»ºè®®ä½¿ç”¨ `docker compose` ä¸ Dockerfile çš„æ„å»ºå‚æ•°è¿›è¡Œå¿«é€Ÿæ„å»ºã€‚

## ğŸ›  å¼€å‘è¿­ä»£å»ºè®®ï¼ˆåŠ é€Ÿåé¦ˆå¾ªç¯ï¼‰
- å¸¸è§„å¼€å‘ï¼šä¼˜å…ˆæœ¬åœ°ä»…é‡å¯å®¹å™¨ + è¿è¡Œè½»é‡ smoke checksï¼ˆé»˜è®¤ç­–ç•¥ï¼‰ä»¥åŠ å¿«è¿­ä»£
- ä¿®æ”¹å…³é”®é€»è¾‘ï¼ˆè®¤è¯ã€DB schemaã€å¤–éƒ¨é›†æˆï¼‰ï¼šå»ºè®®è‡³å°‘è¿è¡Œå¯¹åº”å•å…ƒæµ‹è¯•æˆ–æœ‰é’ˆå¯¹æ€§çš„é›†æˆæµ‹è¯•
- æœ¬åœ°æµ‹è¯• DBï¼šå°½é‡ç”¨ H2 æˆ– mock æ¥é¿å…æ¯æ¬¡éƒ½æ‹‰ MySQL å®¹å™¨
- Playwrightï¼šåœ¨ CI ä½¿ç”¨ headlessï¼Œè°ƒè¯•æ—¶ç”¨ headed å¹¶é…åˆ `--debug` æˆ– `--headed` æ¨¡å¼

## ğŸ” å®‰å…¨ä¸é…ç½®æ³¨æ„äº‹é¡¹
- è¯·ç¡®ä¿ `JWT_SECRET` ä½¿ç”¨é•¿æœŸéšæœºå€¼å¹¶åšå¥½ rotation è®¡åˆ’
- CORSï¼šå¼€å‘æ”¾å®½ï¼Œç”Ÿäº§åŠ¡å¿…é™åˆ¶ origin
- CSRFï¼šPOST/PUT/DELETE çš„è¡¨å•å’Œ UI äº¤äº’åœºæ™¯åœ¨ CSRF ç­–ç•¥ä¸‹éœ€æ³¨æ„åŠ  CSRF token æˆ–åœ¨ API-only åœºæ™¯æ ¡éªŒæˆæƒ

## ğŸ“ˆ å¯è§‚æµ‹æ€§ & æ—¥å¿—
- åç«¯ï¼šSpring Boot æ—¥å¿—ï¼ˆDEBUG å¯æŒ‰éœ€æ‰“å¼€ï¼‰ï¼Œé‡è¦è·¯å¾„è®°å½• INFO
- æ€§èƒ½ï¼šå¯å¼•å…¥ Metrics/Prometheus/Grafanaï¼ˆå½“å‰æœªé›†æˆï¼‰

## ğŸ å¸¸è§æ•…éšœä¸æ’æŸ¥è¦ç‚¹
- æ¢å¤æ¥å£è¿”å› 403ï¼šå¸¸è§åŸå› æ˜¯è¯·æ±‚è¢«è½¬å‘åˆ° `/error`ï¼Œä½† `/error` è¢«å®‰å…¨è§„åˆ™ä¿æŠ¤ï¼Œå¯¼è‡´åŒ¿åè®¿é—®æ—¶å‡ºç° 403ã€‚ä¿®å¤ï¼šæŠŠ `/error` åŠ å…¥ permit list æˆ–æ”¹å–„å¼‚å¸¸å¤„ç†è·¯å¾„ã€‚
- SQLConstraintViolationï¼ˆæ¯”å¦‚ name ä¸ºç©ºï¼‰ï¼šæ›´æ–°æ¥å£è¦é¿å…æŠŠ null è¦†ç›–åˆ°å¼ºåˆ¶å­—æ®µï¼Œä½¿ç”¨æŒ‰å­—æ®µæ¡ä»¶è®¾ç½®ç­–ç•¥ã€‚
- Playwright flakyï¼šä¼˜å…ˆä½¿ç”¨ API é©±åŠ¨ç¨³å®šåœºæ™¯å¹¶å‡å°‘ UI ç‚¹å‡»ä¾èµ–ï¼Œæˆ–åœ¨ CI ä¸­å¢åŠ é‡è¯•ç­–ç•¥ï¼æ˜¾å¼ç­‰å¾…
- Token è§£æé—®é¢˜ï¼šç™»å½•è¿”å›çš„ JSON ä¸­ accessToken å¯èƒ½åŒ…å«æ¢è¡Œï¼ˆè¾“å‡ºæ ¼å¼ï¼‰ï¼Œåœ¨è„šæœ¬ä¸­è¦å»æ‰æ¢è¡Œå†ä½¿ç”¨ã€‚

## ğŸ“‹ å˜æ›´ä¸ä»£ç æäº¤å»ºè®®
- å°æ­¥æäº¤ï¼šæ¯æ¬¡æäº¤åŠŸèƒ½åº”ç”±å°çš„ã€å¯å›æ»šçš„ commit ç»„æˆ
- PR æè¿°ï¼šæ˜ç¡®è¯´æ˜æ”¹åŠ¨è¾¹ç•Œï¼ˆDB schemaã€API contractã€å‰ç«¯å…¼å®¹æ€§ï¼‰å¹¶é™„ä¸Š smoke checks

## ğŸ“ è”ç³»ä¸è´£ä»»
- è´Ÿè´£ç»´æŠ¤ï¼šåç«¯ä¸»è¦ contactï¼ˆä¾‹ï¼š@åç«¯è´Ÿè´£äººï¼‰ï¼Œå‰ç«¯ä¸»è¦ contactï¼ˆä¾‹ï¼š@å‰ç«¯è´Ÿè´£äººï¼‰
- å‡ºé—®é¢˜æ—¶ï¼šä¼˜å…ˆæ”¶é›†æ—¥å¿—ï¼ˆ`docker logs scut_app`ï¼‰ã€é‡ç°æ­¥éª¤ã€å’Œ minimal reproducible case

---

## ğŸ“ é¡¹ç›®æ–‡ä»¶æ ‘ï¼ˆç²¾ç®€è§†å›¾ï¼‰
```
/ (repo root)
â”œâ”€ backend/
â”‚  â”œâ”€ src/main/java/com/scutshop/backend/
â”‚  â”‚  â”œâ”€ controller/ (ProductController.java, AuthController.java)
â”‚  â”‚  â”œâ”€ service/ (ProductService.java, UserService.java)
â”‚  â”‚  â”œâ”€ mapper/ (ProductMapper.java, ProductAuditMapper.java, UserMapper.java)
â”‚  â”‚  â”œâ”€ model/ (Product.java, User.java)
â”‚  â”‚  â””â”€ security/ (JwtTokenProvider.java, JwtAuthenticationFilter.java, SecurityConfig.java)
â”‚  â”œâ”€ src/main/resources/ (application.yml, db/h2-init.sql)
â”‚  â””â”€ src/test/ (integration/unit tests)
â”œâ”€ frontend/
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ App.vue
â”‚  â”‚  â”œâ”€ main.ts
â”‚  â”‚  â”œâ”€ pages/ (AdminProducts.vue, ProductList.vue)
â”‚  â”‚  â”œâ”€ api/ (index.ts)
â”‚  â”‚  â”œâ”€ stores/ (auth.ts)
â”‚  â”‚  â””â”€ router/ (index.ts)
â”‚  â”œâ”€ e2e/ (admin-e2e.spec.ts, product-e2e.spec.ts)
â”‚  â””â”€ playwright.config.ts
â”œâ”€ db/
â”‚  â”œâ”€ schema.sql
â”‚  â”œâ”€ init_admin.sh
â”‚  â””â”€ seed_products.sql
â”œâ”€ docker-compose.yml
â”œâ”€ doc/ (è®¾è®¡æ–‡æ¡£.md, TESTING.md, E2E-debugging.md)
â””â”€ README.md
```

## ğŸ“ é‡è¦æ–‡ä»¶
- `backend/` â€” åç«¯åº”ç”¨
  - `src/main/java/.../controller/ProductController.java`ï¼šäº§å“ç›¸å…³ HTTP æ¥å£ï¼ˆCRUDã€ä¸‹æ¶/æ¢å¤ï¼‰ã€‚æ³¨æ„ï¼šç®¡ç†å‘˜æ¥å£æœ‰ `@PreAuthorize('ROLE_ADMIN')`ã€‚
  - `src/main/java/.../service/ProductService.java`ï¼šä¸šåŠ¡é€»è¾‘ï¼ˆcreate/update/soft-delete/restoreã€è®°å½•å®¡è®¡ï¼‰ã€‚
  - `src/main/java/.../mapper/ProductMapper.java`ï¼šMyBatis æ˜ å°„ï¼ŒåŒ…å« `search/count/setStatus/update/insert` ç­‰ SQL æ“ä½œã€‚
  - `src/main/java/.../mapper/ProductAuditMapper.java`ï¼šå®¡è®¡æ—¥å¿—æ’å…¥ã€‚
  - `src/main/java/.../security/JwtTokenProvider.java`ï¼šJWT ç”Ÿæˆä¸æ ¡éªŒï¼›`JwtAuthenticationFilter.java`ï¼šä» Authorization header æ³¨å…¥ Authenticationï¼›`SecurityConfig.java`ï¼šå®‰å…¨é…ç½®ï¼ˆpermit åˆ—è¡¨ã€CORSã€filter æ³¨å†Œï¼‰ã€‚
  - `src/main/resources/db/h2-init.sql`ï¼šæµ‹è¯•/å¼€å‘ç”¨ H2 åˆå§‹åŒ–è„šæœ¬ï¼ˆåŒ…å« `product_audit` çš„è¡¨å®šä¹‰ï¼‰ã€‚
  - `src/test/`ï¼šå•å…ƒ/é›†æˆæµ‹è¯•ï¼ˆåŒ…å«é’ˆå¯¹ `ProductController` çš„æµ‹è¯•ç”¨ä¾‹ï¼‰ã€‚

- `frontend/` â€” å‰ç«¯ SPA
  - `src/main.ts`ã€`src/App.vue`ï¼šåº”ç”¨å…¥å£ä¸æ ¹ç»„ä»¶ã€‚
  - `src/pages/AdminProducts.vue`ï¼šç®¡ç†å•†å“çš„é¡µé¢ï¼ˆå±•ç¤ºçŠ¶æ€ã€ä¸‹æ¶/æ¢å¤æ“ä½œã€è°ƒç”¨ admin APIï¼‰ã€‚
  - `src/stores/auth.ts`ï¼šç™»å½•ã€fetchMeã€isAdmin getterï¼ˆè·¯ç”±å®ˆå«ä¾èµ–ï¼‰ã€‚
  - `src/api/index.ts`ï¼šå°è£… API è°ƒç”¨ï¼ˆå« Authorization header çš„æ³¨å…¥ç‚¹ï¼‰ã€‚
  - `e2e/admin-e2e.spec.ts`ï¼šPlaywright æµ‹è¯•ï¼ˆæ¨èä½¿ç”¨ API é©±åŠ¨ create/edit ä»¥å‡å°‘ flakinessï¼‰ã€‚

- `db/`ï¼ˆæ•°æ®åº“è„šæœ¬ï¼‰
  - `schema.sql`ï¼šç”Ÿäº§ç¯å¢ƒ MySQL schemaï¼ŒåŒ…å« `product`ã€`product_audit`ã€`user` ç­‰è¡¨ã€‚
  - `seed_products.sql`ï¼šå¼€å‘æ—¶é¢„ç½®æ ·ä¾‹å•†å“ã€‚

- é¡¹ç›®æ ¹
  - `docker-compose.yml`ï¼šå®šä¹‰æœåŠ¡ç¼–æ’ï¼ˆappã€frontendã€dbã€redisã€mailhogã€adminerï¼‰ã€‚éƒ¨ç½²å’Œæœ¬åœ°é›†æˆé¦–é€‰æ–¹å¼ã€‚
- ä»“åº“å·²ç®€åŒ–ä¸ºæœ€å°æ¼”ç¤ºï¼Œå¸¸ç”¨çš„å¿«æ· Makefile ç›®æ ‡ä¸è„šæœ¬å·²è¢«ç§»é™¤ï¼›è¯·ä½¿ç”¨ `docker compose` å®Œæˆå¯åŠ¨ä¸é‡å¯æµç¨‹ã€‚

## ğŸ’¡ æ¯ä¸ªæ–‡ä»¶çš„ç‰¹åˆ«æç¤ºï¼ˆé¿å…å¸¸è§é”™è¯¯ï¼‰
- `ProductController.update`ï¼šä»…å¯¹é null çš„ request å­—æ®µè¿›è¡Œè®¾ç½®ä»¥é¿å…è¦†ç›–æ•°æ®åº“ä¸­çš„å¿…å¡«å­—æ®µä¸º nullï¼ˆå·²ä¿®å¤å†å² BUGï¼‰ã€‚
- `SecurityConfig`ï¼šç¡®ä¿ `/error` åœ¨ permit åˆ—è¡¨ï¼Œå¦åˆ™å¼‚å¸¸è½¬å‘ä¼šå¯¼è‡´ 403ã€‚
- `ProductMapper`ï¼šå¯¹ `search`ã€`count` æ¥å£å¢åŠ  `status` å‚æ•°ä»¥æ”¯æŒç®¡ç†ç«¯æŸ¥è¯¢ï¼ˆstatus=-1 è¡¨ç¤ºå¿½ç•¥ status è¿‡æ»¤ï¼‰ã€‚
- `AdminProducts.vue`ï¼šåœ¨ UI äº¤äº’ä¸ç¨³å®šæ—¶ï¼ŒPlaywright æµ‹è¯•åº”ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨ API å®Œæˆåˆ›å»º/ç¼–è¾‘æ“ä½œï¼›UI ä»…åšè½»é‡æ–­è¨€